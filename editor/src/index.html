<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Editor</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/wysiwyg-editor.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">Content Editor</div>
        </nav>
    </header>

    <main>
        <div class="editor-wrapper">
            <div class="breadcrumb">
                <span>Editing:</span>
                <strong id="current-page">No page selected</strong>
            </div>
            <div class="editor-controls">
                <div class="page-selector">
                    <label for="page-select-main">Select Page:</label>
                    <select id="page-select-main">
                        <optgroup label="Pages">
                            <option value="about">About</option>
                            <option value="index">Home Page</option>
                            <option value="blog/index">Blog Home</option>
                            <option value="contact">Contact</option>
                        </optgroup>
                        <optgroup label="Blog Posts">
                            <option value="blog/bubble-function-blog">Bubble Function Blog</option>
                            <option value="blog/deepest-ocean-case-study">Deepest Ocean Case Study</option>
                        </optgroup>
                        <optgroup label="Case Studies">
                            <option value="case-study/bubble-function-case-study">Bubble Function Case Study</option>
                        </optgroup>
                    </select>
                </div>
                <div class="version-controls" style="display: none;">
                    <label for="version-select">Version:</label>
                    <select id="version-select"></select>
                    <button id="rollback-version" class="button">Rollback to Selected Version</button>
                </div>
                <button class="button" id="export-content">Export All Content</button>
                <button class="button" id="import-content">Import Content</button>
                <input type="file" id="import-file" accept=".json" style="display: none">
                <button id="reload-about" style="display: none;">Reload About Page</button>
            </div>

            <div class="editor-instructions">
                <p>Use the toolbar above to format your content. Available tools:</p>
                <ul>
                    <li>H2 - Create headings</li>
                    <li>Â¶ - Create paragraphs</li>
                    <li>B - Bold text</li>
                    <li>I - Italic text</li>
                    <li>ðŸ”— - Add links</li>
                    <li>â€¢ - Create bullet lists</li>
                    <li>1. - Create numbered lists</li>
                    <li>ðŸ“· - Add images</li>
                    <li> - Add code blocks</li>
                </ul>
            </div>

            <div id="editor" class="wysiwyg-container"></div>
            
            <div class="button-group">
                <button class="button" id="save-content">Save Content</button>
                <button class="button" id="export-current">Export Current Page</button>
                <button class="button" id="update-site">Update Site</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { WYSIWYGEditor } from './components/wysiwyg-editor.js';
        import { ContentManager } from './components/content-manager.js';
        import { ContentExport } from './components/content-export.js';
        import { ContentUpdater } from './utils/content-updater.js';
        import { GitHubUpdater } from './utils/github-updater.js';
        import { config } from './config.js';

        // Initialize editor first
        const editor = new WYSIWYGEditor('#editor', {
            customStyles: [
                {
                    name: 'content-card',
                    label: 'Content Card',
                    html: '<div class="content-card"><div class="content-card-content"></div></div>'
                },
                {
                    name: 'cta-button',
                    label: 'CTA Button',
                    html: '<a href="#" class="cta-button primary">Button Text</a>'
                }
            ]
        });

        // Get DOM elements
        const pageSelect = document.getElementById('page-select-main');
        const currentPageElement = document.getElementById('current-page');

        // Handle page selection
        pageSelect.addEventListener('change', async () => {
            try {
                const selectedPage = pageSelect.value;
                console.log('Page selected:', selectedPage);
                currentPageElement.textContent = ContentManager.getPageTitle(selectedPage);
                
                // Show loading state
                editor.setContent('Loading...');
                
                // Load the content
                const content = await ContentManager.loadContent(selectedPage);
                console.log('Content loaded:', content ? 'yes' : 'no');
                
                if (content) {
                    editor.setContent(content);
                    console.log('Content set in editor');
                } else {
                    editor.setContent('Failed to load content');
                    console.error('No content returned for page:', selectedPage);
                }
            } catch (error) {
                console.error('Error loading page:', error);
                editor.setContent('Error loading content');
            }
        });

        // Initialize other event listeners
        document.getElementById('save-content').addEventListener('click', () => {
            const content = editor.getContent();
            ContentManager.saveContent(pageSelect.value, content);
            alert('Content saved!');
        });

        document.getElementById('export-current').addEventListener('click', () => {
            const pageId = pageSelect.value;
            if (!pageId) {
                alert('Please select a page first');
                return;
            }
            ContentExport.exportPage(pageId);
        });

        // Handle site update
        document.getElementById('update-site').addEventListener('click', async () => {
            const pageId = pageSelect.value;
            if (!pageId) {
                alert('Please select a page first');
                return;
            }

            try {
                // Test repository access first
                await GitHubUpdater.testAccess();
                
                // Get the editor content (now awaiting the async call)
                const content = await editor.getContent();
                console.log('Editor content to update:', content);
                
                // Update the content
                const success = await GitHubUpdater.updateContent(pageId, content);
                if (success) {
                    alert('Content update triggered! Check GitHub Actions for build progress.');
                    window.open(`https://github.com/${config.owner}/${config.repo}/actions`, '_blank');
                }
            } catch (error) {
                console.error('Update failed:', error);
                alert(`Failed to update site: ${error.message}`);
            }
        });

        // ... rest of your event listeners ...
    </script>
</body>
</html> 